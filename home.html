<template>
<!-- top section -->
<div style="display: flex; flex-direction: column;" class="ma-3">
  <div class="top-buttons d-lg-flex d-sm-block justify-space-between align-center">
    <!-- master status -->
    <strong class="text-h6 font-weight-bold text-uppercase text-blue-grey-darken-4">
        status : 
        <span :class="master_status === 'online' ? 'text-teal' : 'text-red-darken-2'">
          {{ master_status }}
        </span>
    </strong>
    <div>
      <!-- refresh button -->
      <v-btn
        outlined
        @click=""
        style="background-color: #a2af9b; color: black"
        class="font-weight-bold text-subtitle-1 text-blue-grey-darken-4 mr-4"
      >
        REFRESH
      </v-btn>
      <!-- sync button -->
      <v-btn
        outlined
        style="background-color: #a2af9b; color: black"
        class="font-weight-bold text-subtitle-1 text-blue-grey-darken-4"
        :loading="isLoading"
        :disabled="isLoading"
        @click="syncSlave"
      >
        <template v-slot:loader>
          <v-progress-circular indeterminate color="white" size="20"></v-progress-circular>
        </template>
        <span v-if="!isLoading">SYNC</span>
        <span v-else>Loading...</span>
      </v-btn>
    </div>
</div>
<!-- dashboard slave configs -->
<v-row class="mt-5 pa-4 rounded-lg" style="background-color: #a2af9b; color: black">
  <v-col
    v-for="(node, index) in slave_nodes"
    :key="index"
    cols="12"
    sm="6"
    md="6"
    color="primary"
  >
    <v-sheet class="pa-3 text-subtitle-1 text-blue-grey-darken-4 rounded-lg"  color="primary" elevation="1">
      <v-sheet color="primary">
        <p>Node Status : {{ node.node_status }}</p>
        <p>Node ID : {{ node.node_id }}</p>
        <p>MAC Addr : {{ node.mac_address }}</p>
        <p>Node Type : {{ node.node_type }}</p>
        <p>Description : {{ node.description }}</p>
      </v-sheet>
    </v-sheet>
  </v-col>
</v-row>
</template>
<script>
export default {
  mounted() {
    if (localStorage.getItem("loggedIn") === "false") {
        this.redirectLogin();
    }
    // get data from mongoDB at first
    this.getNodesMongoDB();
    // ping at initial
    this.checkMasterStatus();
    // get slave node status
    this.checkNodeStatus();
  },
  data() {
    return {
      slave_nodes: [],
      getNode_request: false,
      ping_request: false,
      allNode_request: false,
      activeNode_request: false,
      isLoading: false,
      master_status: "offline",
    };
  },
  watch: {
    msg(newMsg) {
      // MongoDB handle 

      // getNodes handle
      if (newMsg.type == "MONGO_DB" && this.getNode_request) {
        this.isLoading = false;

        // add node_status key to slave nodes
        this.slave_nodes = Object.values(newMsg.payload).map(node => ({
          ...node,
          node_status: "offline"
        }));

        this.getNode_request = false;
      }

      // pong handler
      if (newMsg.type == "PONG" && this.ping_request) {
        this.master_status = "online"
        if (this.ping_delay < 2) {
          this.ping_delay += 2;
        }
        this.ping_request = false; 
      }

      // get active node handler
      if (newMsg.type == "ACTIVE_NODE" && this.activeNode_request) {
        this.activeNode_request = false;

        // Merge state from payload into slave_nodes
        this.slave_nodes = this.slave_nodes.map(node => {
          const key = node.mac_address;
          if (newMsg.payload[key] && newMsg.payload[key].state) {
            return {
              ...node,
              state: newMsg.payload[key]?.state || {},  // merge state
              node_status: "online"
            };
          } else {
            console.log("Aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")
            return {
              ...node,
              node_status: "offline"
            };
          }
        });
      }

      // get all node handler
      if (newMsg.type == "ALL_NODE" && this.allNode_request) {
        this.allNode_request = false;
        
        // delete old slave nodes in DB
        const dropObj = {
          collection: "nodes",
          payload: {},
          operation: "deleteMany",
          type: "MONGO_DB"
        };
        this.send(dropObj);

        // upload new slave nodes to DB after 1.5 sec
        setTimeout(() => {
          const insertObj = {
            collection: "nodes",
            payload: [Object.values(newMsg.payload)],
            operation: "insertMany",
            type: "MONGO_DB"
          };
          this.send(insertObj);
          this.getNodesMongoDB();
        }, 1500);
      }
    }
  },
  methods: {
    // prevent unlogin user
    redirectLogin() {
      const base = window.location.origin;
      window.location.href = `${base}/dashboard/login`;
    },
    // send request to mongoDB to get slave nodes
    getNodesMongoDB() {
      const sendObj = {
        collection: "nodes",
        operation: "find.toArray",
        type: "MONGO_DB"
      };
      this.getNode_request = true, 
      this.send(sendObj);
    },
    // check master node status every 5 sec
    checkMasterStatus() {
      const sendObj = {
        payload: "ping",
        type: "PING"
      };
      this.ping_request = true;
      this.send(sendObj);

      // send ping payload to master node 5 sec interval
      setInterval(() => {
        this.ping_request = true; 
        // online & offline logic
        if (this.ping_delay == 0) {
          this.master_status = "offline";
        } else {
          this.master_status = "online";
          this.ping_delay -= 1;
        }
        this.send(sendObj);
      }, 5000); // 5000 ms = 5 second
    },
    // check slave node status every 1 sec
    checkNodeStatus() {
      const sendObj = {
        payload: "active",
        type: "ACTIVE_NODE"
      };
      this.activeNode_request = true;
      this.send(sendObj);

      // send check payload to master node 1 sec interval
      setInterval(() => {
        this.activeNode_request = true; 
        this.send(sendObj);
      }, 1000); // 1000 ms = 1 second
    },
    // get entire slave node to replace to mongoDB nodes collection
    syncSlave() {
      this.allNode_request = true;
      const sendObj = {
        payload: "getAllNode",
        type: "ALL_NODE"
      }
      this.send(sendObj);
      this.isLoading = true;
    }
  }
};
</script>

<!-- 

- get active node and match to node in database to tell which node is online [ master online condition ] on open webpage
- refresh button to get active node again
- naming system and update to database
- config relay slave 
- config type of sensor (button, toggle, relay)
-->
